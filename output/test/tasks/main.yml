  - name: Update apt cache
    apt:
      update_cache: true
  - name: Install nginx
    package:
      name: nginx
      state: present
  - name: Include test site recipe
    include_tasks: test_site.yml
  - name: Update apt cache
    apt:
      update_cache: true
  - name: Install nginx from repo
    include_tasks: nginx_install.yml
  - name: Include test site recipe
    include_tasks: test_site.yml
  - name: Install nginx from epel
    package:
      name: nginx
      state: present
    notify: Restart nginx
  - name: Include test_site recipe
    include_tasks: test_site.yml
  - name: Add test_site hosts entry
    lineinfile:
      path: /etc/hosts
      line: 127.0.0.1  test_site
      state: present
    become: true
  - name: Configure nginx
    template:
      src: nginx.conf.j2
      dest: /etc/nginx/nginx.conf
      mode: '0755'
    vars:
      types_hash_max_size: 2048
    notify: Restart nginx
  - name: Create test_site configuration
    template:
      src: test_site.conf.j2
      dest: /etc/nginx/sites-available/test_site
      mode: '0644'
    vars:
      server:
        listen:
          - '*:80'
        server_name:
          - test_site
        access_log: /var/log/nginx/test_site.access.log
        locations:
          /:
            root: /var/www/nginx-default
            index: index.html index.htm
            proxy_set_header:
              - Connection ""
              - X-My-Real-IP $remote_addr
              - X-My-Real-Port $remote_port
              - X-My-Server-Port $server_port
            limit_except: GET POST { deny all; }
    notify: Reload nginx
  - name: Create and disable test_site_disabled configuration
    template:
      src: default-site.j2
      dest: /etc/nginx/sites-available/test_site_disabled
    vars:
      port: 80
      server_name: test_site
      default_root: /var/www/nginx-default
      nginx_log_dir: /var/log/nginx
    notify: Reload nginx
  - name: Disable test_site_disabled
    file:
      path: /etc/nginx/sites-enabled/test_site_disabled
      state: absent
    notify: Reload nginx
  - name: Create foo site configuration
    template:
      src: override-site-template.j2
      dest: /etc/nginx/sites-available/foo
      mode: '0644'
    vars:
      upstream:
        bar:
          server: localhost:1234
    notify: Reload nginx
  - name: Enable nginx service
    service:
      name: nginx
      enabled: true
      state: started
  - name: Include repo recipe
    include_tasks: repo.yml
  - name: Include test_site recipe
    include_tasks: test_site.yml
  - name: Create test_invalid_site
    template:
      src: default-site.j2
      dest: /etc/nginx/sites-available/test_invalid_site
    vars:
      port: im not a port
      server_name: test_site
      default_root: /var/www/html
      nginx_log_dir: /var/log/nginx
    notify: Reload nginx
  - name: Update apt cache
    apt:
      update_cache: true
  - name: Install nginx-full package
    package:
      name: nginx-full
      state: present
  - name: Include test_site recipe
    include_tasks: test_site.yml
